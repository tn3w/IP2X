name: Update IP Databases

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Create data directory
        run: mkdir -p data

      - name: Download IP2Location databases
        env:
          IP2LOCATION_TOKEN: ${{ secrets.IP2LOCATION_TOKEN }}
        run: |
          for DB in DB5LITECSV DB5LITECSVIPV6 DBASNLITE DBASNLITEIPV6 PX12LITECSV PX12LITECSVIPV6; do
            echo "Downloading ${DB}..."
            curl -L -o temp.zip "https://www.ip2location.com/download/?file=${DB}&token=${IP2LOCATION_TOKEN}"
            unzip -j temp.zip "*.CSV" -d data/
            rm temp.zip
          done

      - name: Download GeoLite2 database
        run: |
          curl -L -o data/GeoLite2-City.mmdb "https://github.com/P3TERX/GeoLite.mmdb/releases/latest/download/GeoLite2-City.mmdb"

      - name: Build binary databases
        run: cargo run --release

      - name: Create Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          TAG_NAME="v$(date -u +%Y%m%d-%H%M%S)"

          gh release create "$TAG_NAME" \
            geo.bin \
            proxy_types.bin \
            asn.bin \
            isp.bin \
            --title "IP Database Update - $TIMESTAMP" \
            --notes "Automated IP geolocation and proxy database update.

          **Files:**
          - \`geo.bin\` - IP geolocation data (latitude/longitude)
          - \`proxy_types.bin\` - Proxy type detection data
          - \`asn.bin\` - Autonomous System Number data
          - \`isp.bin\` - ISP and domain information

          **Download:**
          \`\`\`bash
          curl -L -O https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/geo.bin
          curl -L -O https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/proxy_types.bin
          curl -L -O https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/asn.bin
          curl -L -O https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/isp.bin
          \`\`\`"

      - name: Cleanup old releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASES=$(gh release list --limit 100 --json tagName,createdAt --jq 'sort_by(.createdAt) | reverse | .[].tagName')
          COUNT=0
          for TAG in $RELEASES; do
            COUNT=$((COUNT + 1))
            if [ $COUNT -gt 3 ]; then
              echo "Deleting old release: $TAG"
              gh release delete "$TAG" --yes 2>/dev/null || true
              git push --delete origin "$TAG" 2>/dev/null || true
            fi
          done
